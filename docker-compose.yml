services:
  codex:
    build:
      context: .
      dockerfile: Dockerfile
    image: codex-rocky:9
    container_name: "codex-${REPO}"
    stdin_open: true
    tty: true
    working_dir: /workspace
    environment:
      - PAGER=less
    volumes:
      # ---- repos we will analyze ----
      - "${CODEX_HOST_DIR}/codex-repos/${REPO}:/workspace"
      - "${CODEX_HOST_DIR}/codex-state/shared/AGENTS.md:/workspace/AGENTS.md"

      # ---- shared, keep across repos ----
      - "${CODEX_HOST_DIR}/codex-state/shared/config.toml:/home/codex/.codex/config.toml"
      - "${CODEX_HOST_DIR}/codex-state/shared/auth.json:/home/codex/.codex/auth.json"
      - "${CODEX_HOST_DIR}/codex-state/shared/skills:/home/codex/.codex/skills"
      - "${CODEX_HOST_DIR}/codex-state/shared/models_cache.json:/home/codex/.codex/models_cache.json"
      - "${CODEX_HOST_DIR}/codex-state/shared/version.json:/home/codex/.codex/version.json"
      - "${CODEX_HOST_DIR}/codex-state/shared/.ssh:/home/codex/.ssh:ro"
      - "${CODEX_HOST_DIR}/codex-state/shared/.gitconfig:/home/codex/.gitconfig:ro"

      # ---- repo-scoped state ----
      - "${CODEX_HOST_DIR}/codex-state/repos/${REPO}/sessions:/home/codex/.codex/sessions"
      - "${CODEX_HOST_DIR}/codex-state/repos/${REPO}/history.jsonl:/home/codex/.codex/history.jsonl"
      - "${CODEX_HOST_DIR}/codex-state/repos/${REPO}/log:/home/codex/.codex/log"
      - "${CODEX_HOST_DIR}/codex-state/repos/${REPO}/tmp:/home/codex/.codex/tmp"
